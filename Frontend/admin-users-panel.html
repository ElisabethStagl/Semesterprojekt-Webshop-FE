<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Users</title>
    <link rel="icon" href="images/clementine.png" sizes="16x16 32x32" type="image/png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.3.js"
        integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/stylesheet.css" />
</head>

<body>

    <div id="navbar"></div>

    <div class="container content">
        <h2 id="admin-header" style="display: none;">Admin Panel - User List</h2>
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4" id="userCardContainer" style="display:none;">   <!-- Initially hidden until validated -->              
    </div>
        <div id="error-message" style="display:none;"> <!-- Error message area -->
            <h4>Access Denied!</h4>
            <p> You do not have permission to view this content.</p>
        </div>
    </div>


    <div id="footer"></div>

    <script>
        function getAuthHeaders() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                alert('Not authenticated!');
                window.location.href = 'login.html'; // Redirect to login or other appropriate page
                return {};
            }
            return {
                'Authorization': 'Bearer ' + token
            };
        }

        function handleResponse(response) {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }
            return response.json();
        }

        // Function to create a user card
        function createUserCard(user) {
        const card = $('<div class="col-lg-3 col-md-4 col-sm-6 mt-3"></div>');
        const cardInner = $('<div class="card mx-auto mb-5" style="background-color:transparent;"></div>');
        const cardHeader = $(`<div class="card-header" data-bs-toggle="collapse" href="#collapse${user.id}" role="button" aria-expanded="false"></div>`);
        
        const username = $(`<h5 class="card-title">Username: ${user.username}</h5>`);
        const email = $(`<p class="card-text">Email: ${user.email}</p>`);
        const role = $(`<p class="card-text">Role: ${user.role}</p>`);

        cardHeader.append(username, email, role);
        
        const cardBody = $('<div class="card-body collapse" id="collapse' + user.id + '"></div>');
        const id = $(`<p class="card-text">ID: ${user.id}</p>`);
        const sex = $(`<p class="card-text">Geschlecht: ${user.sex}</p>`);
        const firstName = $(`<p class="card-text">First Name: ${user.firstName} </p>`);
        const lastName = $(`<p class="card-text">Last Name: ${user.lastName}</p>`);
        const address = $(`<p class="card-text">Adresse: ${user.address}</p>`);
        const doornumber = $(`<p class="card-text">Door Number: ${user.doornumber}</p>`);
        const postalCode = $(`<p class="card-text">Postal Code: ${user.postalCode}</p>`);
        const city = $(`<p class="card-text">City: ${user.city}</p>`);

        const editButton = $('<button class="btn btn-primary me-3">Edit</button>');
        const deleteButton = $('<button class="btn btn-primary">Delete</button>');

        editButton.on('click', (e) => {
            e.stopPropagation();  // Prevents the card from toggling when the button is clicked
            console.log('Edit button clicked for user:', user.id);
        });

        deleteButton.on('click', (e) => {
            e.stopPropagation();  // Prevents the card from toggling when the button is clicked
            console.log('Delete button clicked for user:', user.id);
        });

        cardBody.append(id, sex, firstName, lastName, address, doornumber, postalCode, city, editButton, deleteButton);
        cardInner.append(cardHeader, cardBody);
        card.append(cardInner);

        return card;
    }

        // First, fetch the current user details
        fetch("http://localhost:8080/users/current-user", {
            method: "GET",
            headers: getAuthHeaders()
        })
            .then(handleResponse)
            .then(currentUser => {
                if (currentUser.role === "ROLE_ADMIN") {
                    return fetch("http://localhost:8080/admin/users", {
                        headers: getAuthHeaders()
                    });
                } else {
                    throw new Error('User is not an admin');
                }
            })
            .then(handleResponse)
            .then(users => {
                const userCardContainer = $('#userCardContainer'); // Add a container in your HTML where user cards will be displayed
                users.forEach(user => {
                    const userCard = createUserCard(user);
                    userCardContainer.append(userCard);


                    // Once data is populated, display the content
                    document.getElementById('userCardContainer').style.display = 'flex';
                    document.getElementById('admin-header').style.display = 'block';
                });
            })
            .catch(error => {
                console.error('Error:', error.message);
                document.getElementById('error-message').style.display = 'block';
            });
    </script>
    <script src="./javascript/main.js"></script>

</body>

</html>